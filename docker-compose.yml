# ============================================================================
# MONITOR-INFRA - Docker Stack para Portainer
# Compatível com: Docker Swarm + Traefik v3
# ============================================================================
#
# COMO USAR NO PORTAINER:
# 1. Vá em Stacks > Add stack
# 2. Cole este arquivo ou use "Repository" apontando para o GitHub
# 3. Configure as variáveis de ambiente no .env
# 4. Deploy the stack
#
# ============================================================================

networks:
  network_public:
    name: network_public
    external: true

volumes:
  monitor-infra-data:
    name: monitor-infra-data
    external: true

services:
  # ==========================================================================
  # MONITOR-INFRA SERVER
  # ==========================================================================
  monitor-infra-service:
    image: ghcr.io/guilhermejansen/monitor-infra:latest

    networks:
      - network_public

    volumes:
      - monitor-infra-data:/app/data

    environment:
      - AUTH_TOKEN=seu-token-secreto-aqui
      - RETENTION_DAYS=90
      - TZ=America/Sao_Paulo

    command:
      - --port=8080
      - --db=/app/data/monitor.db
      - --token=seu-token-secreto-aqui
      - --retention=90

    deploy:
      mode: replicated
      replicas: 1

      placement:
        constraints:
          - node.role == manager

      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first

      rollback_config:
        parallelism: 1
        delay: 10s

      # ========================================================================
      # TRAEFIK V3 LABELS
      # ========================================================================
      labels:
        # Habilitar Traefik
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"

        # ---------------------------------------------------------------------
        # HTTP Router (Redirect para HTTPS)
        # ---------------------------------------------------------------------
        - "traefik.http.routers.monitor-infra-http.rule=Host(`monitor.seudominio.com`)"
        - "traefik.http.routers.monitor-infra-http.entrypoints=http"
        - "traefik.http.routers.monitor-infra-http.middlewares=https-redirect"

        # ---------------------------------------------------------------------
        # HTTPS Router (Principal)
        # ---------------------------------------------------------------------
        - "traefik.http.routers.monitor-infra-https.rule=Host(`monitor.seudominio.com`)"
        - "traefik.http.routers.monitor-infra-https.entrypoints=https"
        - "traefik.http.routers.monitor-infra-https.tls=true"
        - "traefik.http.routers.monitor-infra-https.tls.certresolver=letsencrypt"
        - "traefik.http.routers.monitor-infra-https.service=monitor-infra-service"

        # ---------------------------------------------------------------------
        # Service
        # ---------------------------------------------------------------------
        - "traefik.http.services.monitor-infra-service.loadbalancer.server.port=8080"
        - "traefik.http.services.monitor-infra-service.loadbalancer.healthcheck.path=/api/health"
        - "traefik.http.services.monitor-infra-service.loadbalancer.healthcheck.interval=30s"
        - "traefik.http.services.monitor-infra-service.loadbalancer.healthcheck.timeout=5s"

        # ---------------------------------------------------------------------
        # Middlewares
        # ---------------------------------------------------------------------
        # Redirect HTTP -> HTTPS
        - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
        - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"

        # Security Headers
        - "traefik.http.middlewares.monitor-headers.headers.stsSeconds=31536000"
        - "traefik.http.middlewares.monitor-headers.headers.stsIncludeSubdomains=true"
        - "traefik.http.middlewares.monitor-headers.headers.stsPreload=true"
        - "traefik.http.middlewares.monitor-headers.headers.forceSTSHeader=true"
        - "traefik.http.middlewares.monitor-headers.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.monitor-headers.headers.browserXssFilter=true"
        - "traefik.http.middlewares.monitor-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
        - "traefik.http.middlewares.monitor-headers.headers.customFrameOptionsValue=SAMEORIGIN"

        # Aplicar middlewares ao router HTTPS
        - "traefik.http.routers.monitor-infra-https.middlewares=monitor-headers"

        # Compress
        - "traefik.http.middlewares.monitor-compress.compress=true"

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
